# Nomad Server Configuration
# Auto-generated by Ansible

datacenter = "{{ datacenter }}"
region = "{{ region }}"
data_dir = "{{ nomad_data_dir }}"
log_level = "{{ nomad_log_level }}"

bind_addr = "0.0.0.0"

advertise {
  http = "{{ ansible_host }}"
  rpc = "{{ ansible_host }}"
  serf = "{{ ansible_host }}"
}

server {
  enabled = true
  bootstrap_expect = {{ nomad_bootstrap_expect }}

  # Gossip encryption for secure server-to-server communication
  encrypt = "{{ hostvars[groups['nomad_servers'][0]]['nomad_gossip_key'] }}"

  # Server join configuration for multi-master setup
  server_join {
    retry_join = {{ nomad_retry_join | to_json }}
    retry_max = 5
    retry_interval = "15s"
  }
}

{% if enable_tls | bool %}
# TLS Configuration for secure communication
tls {
  http = true
  rpc = true

  ca_file = "{{ tls_dir }}/ca.pem"
  cert_file = "{{ tls_dir }}/nomad.pem"
  key_file = "{{ tls_dir }}/nomad.key"

  verify_server_hostname = true
  verify_https_client = false
}
{% endif %}

{% if nomad_acl_enabled | bool %}
# ACL Configuration
acl {
  enabled = true
}
{% endif %}

# Consul Integration
consul {
{% if enable_tls | bool %}
  address = "127.0.0.1:8501"
  ssl = true
  ca_file = "{{ tls_dir }}/ca.pem"
  cert_file = "{{ tls_dir }}/consul.pem"
  key_file = "{{ tls_dir }}/consul.key"
{% else %}
  address = "127.0.0.1:8500"
{% endif %}
  server_service_name = "nomad"
  client_service_name = "nomad-client"
  auto_advertise = true
  server_auto_join = true
  client_auto_join = true
}

# UI Configuration
ui {
  enabled = {{ nomad_ui_enabled | lower }}
}

# Telemetry
telemetry {
  prometheus_metrics = true
  disable_hostname = true
  publish_allocation_metrics = true
  publish_node_metrics = true
}
