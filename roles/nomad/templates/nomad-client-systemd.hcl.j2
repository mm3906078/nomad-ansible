# Nomad Client Configuration - Systemd Workers
# Auto-generated by Ansible

datacenter = "{{ datacenter }}"
region = "{{ region }}"
data_dir = "{{ nomad_data_dir }}"
log_level = "{{ nomad_log_level }}"

bind_addr = "0.0.0.0"

advertise {
  http = "{{ ansible_host }}"
  rpc = "{{ ansible_host }}"
  serf = "{{ ansible_host }}"
}

client {
  enabled = true

  # Join Nomad servers
  servers = {{ nomad_retry_join | to_json }}

  # Node metadata for targeting jobs
  meta {
    "node_type" = "systemd"
    "exec_enabled" = "true"
  }

  # Host volumes for persistent storage
  host_volume "shared" {
    path = "/opt/nomad/volumes/shared"
    read_only = false
  }

  # Garbage collection settings
  gc_interval = "{{ nomad_gc_interval }}"
  gc_disk_usage_threshold = {{ nomad_gc_disk_usage_threshold }}
  gc_inode_usage_threshold = {{ nomad_gc_inode_usage_threshold }}
}

# Enable exec driver for systemd-based workloads
plugin "exec" {
  config {
    no_pivot_root = false
  }
}

# Enable raw_exec driver (SECURITY WARNING: runs with same privileges as Nomad)
# Only enable if you understand the security implications and trust all job submitters
# Consider disabling in production or using exec driver instead
plugin "raw_exec" {
  config {
    enabled = {{ raw_exec_enabled | default(false) | lower }}
  }
}

# Consul Integration
consul {
  address = "127.0.0.1:8500"
  auto_advertise = true
  server_auto_join = true
  client_auto_join = true
}

# Telemetry
telemetry {
  prometheus_metrics = true
  disable_hostname = true
  publish_allocation_metrics = true
  publish_node_metrics = true
}
