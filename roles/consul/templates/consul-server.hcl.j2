# Consul Server Configuration
# Auto-generated by Ansible

datacenter = "{{ datacenter }}"
data_dir = "{{ consul_data_dir }}"
log_level = "{{ consul_log_level }}"

server = true
bootstrap_expect = {{ consul_bootstrap_expect }}

bind_addr = "{{ ansible_host }}"
client_addr = "0.0.0.0"

ui_config {
  enabled = {{ consul_ui_enabled | lower }}
}

# Retry join configuration for multi-master setup
retry_join = {{ consul_retry_join | to_json }}

# Gossip encryption
encrypt = "{{ hostvars[groups['consul_servers'][0]]['consul_gossip_key'] }}"

{% if enable_tls | bool %}
# TLS Configuration for secure communication
tls {
  defaults {
    ca_file = "{{ tls_dir }}/ca.pem"
    cert_file = "{{ tls_dir }}/consul.pem"
    key_file = "{{ tls_dir }}/consul.key"
    verify_incoming = true
    verify_outgoing = true
  }

  internal_rpc {
    verify_server_hostname = true
  }
}

# HTTPS configuration
ports {
  http = -1
  https = 8501
  grpc = -1
  grpc_tls = 8503
}
{% else %}
ports {
  http = 8500
  https = -1
  grpc = 8502
  grpc_tls = -1
}
{% endif %}

{% if enable_acl | bool %}
# ACL Configuration
acl {
  enabled = true
  default_policy = "{{ consul_acl_default_policy }}"
  enable_token_persistence = true
}
{% endif %}

# Performance tuning
performance {
  raft_multiplier = 1
}

# Connect service mesh
connect {
  enabled = true
}
